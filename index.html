<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Visualizer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      display: block;
      cursor: pointer;
    }
    .hidden-cursor {
      cursor: none;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      transition: opacity 0.5s; /* already smooth */
    }
    button, input[type="range"], input[type="file"] {
      margin: 4px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: rgba(255,255,255,0.2);
    }
    label {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="fileInput" accept="audio/*"><br>
    <button id="playBtn" disabled>Play</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="modeBtn" disabled>Switch Mode</button><br>
    <label>Bar Height: <input type="range" id="heightSlider" min="0.5" max="5" value="2.5" step="0.1"></label>
  </div>
  <canvas id="visualizer"></canvas>

  <script>
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let audioContext, analyser, dataArray, bufferLength, source;
    let audio;
    let mode = "frequency";
    let barScale = 2.5;

    const controls = document.getElementById("controls");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const modeBtn = document.getElementById("modeBtn");
    const heightSlider = document.getElementById("heightSlider");

    // --- Audio file input ---
    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (audio) {
        audio.pause();
        audio.remove();
      }

      audio = new Audio();
      audio.src = URL.createObjectURL(file);
      audio.controls = false;
      audio.autoplay = true;
      document.body.appendChild(audio);
      audio.style.display = "none";

      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      source = audioContext.createMediaElementSource(audio);
      analyser = audioContext.createAnalyser();
      source.connect(analyser);
      analyser.connect(audioContext.destination);

      analyser.fftSize = 2048;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      playBtn.disabled = false;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      modeBtn.disabled = false;

      draw();
    });

    // --- Controls ---
    playBtn.addEventListener("click", () => {
      if (audioContext.state === "suspended") audioContext.resume();
      audio.play();
    });

    pauseBtn.addEventListener("click", () => audio.pause());
    stopBtn.addEventListener("click", () => { audio.pause(); audio.currentTime = 0; });
    modeBtn.addEventListener("click", () => mode = (mode === "frequency") ? "waveform" : "frequency");
    heightSlider.addEventListener("input", () => barScale = parseFloat(heightSlider.value));

    // --- Keyboard shortcuts ---
    document.addEventListener("keydown", (e) => {
      if (!audio) return;
      if (e.code === "Space") { e.preventDefault(); audio.paused ? audio.play() : audio.pause(); }
      else if (e.key.toLowerCase() === "r") { audio.currentTime = 0; audio.pause(); }
      else if (e.key.toLowerCase() === "s") { mode = (mode === "frequency") ? "waveform" : "frequency"; }
    });

    // --- Fullscreen toggle ---
    canvas.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        canvas.requestFullscreen().catch(err => console.log(err));
      } else {
        document.exitFullscreen();
      }
    });

    // --- Hide controls and cursor in fullscreen ---
    document.addEventListener("fullscreenchange", () => {
      if (document.fullscreenElement) {
        canvas.style.cursor = "none";   // hide cursor
        controls.style.opacity = 0;     // fade out
      } else {
        canvas.style.cursor = "pointer"; // show cursor
        controls.style.opacity = 1;      // fade back in
      }
    });

    // --- Draw visualizer ---
    function draw() {
      requestAnimationFrame(draw);
      if (!analyser) return;

      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (mode === "frequency") {
        analyser.getByteFrequencyData(dataArray);
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const amplitude = dataArray[i];

          const loudness = amplitude;

          const barHeight = loudness * barScale;
          const hue = (i / bufferLength) * 360;
          const alpha = Math.min(1, amplitude / 255);

          ctx.fillStyle = `hsla(${hue}, 100%, 50%, ${alpha})`;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      } else {
        analyser.getByteTimeDomainData(dataArray);

        ctx.lineWidth = 2;
        ctx.strokeStyle = "rgb(0, 200, 255)";
        ctx.beginPath();

        const sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;

          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);

          x += sliceWidth;
        }

        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
      }
    }

    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
